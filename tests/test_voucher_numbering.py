#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ä»•è¨³Noä»˜ç•ªãƒ†ã‚¹ãƒˆ - è²¸å€Ÿä¸€è‡´ãƒ–ãƒ­ãƒƒã‚¯æ–¹å¼
è¦ä»¶ã«æ²¿ã£ãŸå‹•ä½œã‚’æ¤œè¨¼ã™ã‚‹
"""

import sys
from pathlib import Path

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã‚’è¿½åŠ 
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from utils.voucher_numbering import (
    assign_voucher_numbers,
    sort_by_voucher_number,
    validate_overall_balance,
    is_header_line
)


def test_basic_balance_close():
    """åŸºæœ¬çš„ãªè²¸å€Ÿä¸€è‡´ã§ãƒ–ãƒ­ãƒƒã‚¯ãŒç¢ºå®šã™ã‚‹ãƒ†ã‚¹ãƒˆ"""
    print("\nğŸ§ª ãƒ†ã‚¹ãƒˆ1: åŸºæœ¬çš„ãªè²¸å€Ÿä¸€è‡´ãƒ–ãƒ­ãƒƒã‚¯")

    entries = [
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/01", "å€Ÿè²¸åŒºåˆ†": "å€Ÿæ–¹", "ç§‘ç›®å": "ç¾é‡‘", "é‡‘é¡": 10000, "æ‘˜è¦": "å®¶è³ƒåå…¥"},
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/01", "å€Ÿè²¸åŒºåˆ†": "è²¸æ–¹", "ç§‘ç›®å": "å£²ä¸Š", "é‡‘é¡": 10000, "æ‘˜è¦": "å®¶è³ƒåå…¥"},
    ]

    result = assign_voucher_numbers(entries, prefer_llm=False, width=4)

    # æ¤œè¨¼
    assert len(result) == 2, f"è¡Œæ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“: æœŸå¾…=2, å®Ÿéš›={len(result)}"
    assert result[0]["ä»•è¨³No"] == "0001", f"ä»•è¨³Noä¸ä¸€è‡´: {result[0]['ä»•è¨³No']}"
    assert result[1]["ä»•è¨³No"] == "0001", f"ä»•è¨³Noä¸ä¸€è‡´: {result[1]['ä»•è¨³No']}"
    assert result[0]["warning"] == "", f"è­¦å‘ŠãŒå‡ºã¦ã„ã¾ã™: {result[0]['warning']}"

    print("âœ… ãƒ†ã‚¹ãƒˆ1åˆæ ¼: è²¸å€Ÿä¸€è‡´ã§ä»•è¨³No=0001ãŒä»˜ç•ªã•ã‚Œã¾ã—ãŸ")
    return True


def test_multiple_vouchers():
    """è¤‡æ•°ä¼ç¥¨ãŒæ­£ã—ãåˆ†é›¢ã•ã‚Œã‚‹ãƒ†ã‚¹ãƒˆ"""
    print("\nğŸ§ª ãƒ†ã‚¹ãƒˆ2: è¤‡æ•°ä¼ç¥¨ã®åˆ†é›¢")

    entries = [
        # ä¼ç¥¨1: å€Ÿæ–¹1+è²¸æ–¹1
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/01", "å€Ÿè²¸åŒºåˆ†": "å€Ÿæ–¹", "ç§‘ç›®å": "ç¾é‡‘", "é‡‘é¡": 10000, "æ‘˜è¦": "å®¶è³ƒåå…¥"},
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/01", "å€Ÿè²¸åŒºåˆ†": "è²¸æ–¹", "ç§‘ç›®å": "å£²ä¸Š", "é‡‘é¡": 10000, "æ‘˜è¦": "å®¶è³ƒåå…¥"},
        # ä¼ç¥¨2: å€Ÿæ–¹1+è²¸æ–¹1ï¼ˆãƒ˜ãƒƒãƒ€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é¿ã‘ã‚‹ãŸã‚ã€Œçµ¦ä¸ã€ã«å¤‰æ›´ï¼‰
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/02", "å€Ÿè²¸åŒºåˆ†": "å€Ÿæ–¹", "ç§‘ç›®å": "çµ¦ä¸", "é‡‘é¡": 20000, "æ‘˜è¦": "çµ¦ä¸æ”¯çµ¦"},
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/02", "å€Ÿè²¸åŒºåˆ†": "è²¸æ–¹", "ç§‘ç›®å": "ç¾é‡‘", "é‡‘é¡": 20000, "æ‘˜è¦": "çµ¦ä¸æ”¯çµ¦"},
    ]

    result = assign_voucher_numbers(entries, prefer_llm=False, width=4)

    # æ¤œè¨¼
    assert len(result) == 4, f"è¡Œæ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“: æœŸå¾…=4, å®Ÿéš›={len(result)}"
    assert result[0]["ä»•è¨³No"] == "0001", f"ä»•è¨³Noä¸ä¸€è‡´"
    assert result[1]["ä»•è¨³No"] == "0001", f"ä»•è¨³Noä¸ä¸€è‡´"
    assert result[2]["ä»•è¨³No"] == "0002", f"ä»•è¨³Noä¸ä¸€è‡´"
    assert result[3]["ä»•è¨³No"] == "0002", f"ä»•è¨³Noä¸ä¸€è‡´"

    print("âœ… ãƒ†ã‚¹ãƒˆ2åˆæ ¼: 2ã¤ã®ä¼ç¥¨ãŒ0001ã¨0002ã«åˆ†é›¢ã•ã‚Œã¾ã—ãŸ")
    return True


def test_header_boundary():
    """ãƒ˜ãƒƒãƒ€èªå¥ã§å¼·åˆ¶åˆ†é›¢ã•ã‚Œã‚‹ãƒ†ã‚¹ãƒˆ"""
    print("\nğŸ§ª ãƒ†ã‚¹ãƒˆ3: ãƒ˜ãƒƒãƒ€èªå¥ã«ã‚ˆã‚‹å¼·åˆ¶åˆ†é›¢")

    entries = [
        # ä¼ç¥¨1ï¼ˆå®Œæˆï¼‰
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/01", "å€Ÿè²¸åŒºåˆ†": "å€Ÿæ–¹", "ç§‘ç›®å": "ç¾é‡‘", "é‡‘é¡": 10000, "æ‘˜è¦": "å®¶è³ƒåå…¥"},
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/01", "å€Ÿè²¸åŒºåˆ†": "è²¸æ–¹", "ç§‘ç›®å": "å£²ä¸Š", "é‡‘é¡": 10000, "æ‘˜è¦": "å®¶è³ƒåå…¥"},
        # ä¼ç¥¨2ï¼ˆãƒ˜ãƒƒãƒ€è¡Œã‹ã‚‰é–‹å§‹ï¼‰- æœ€åˆã®è¡Œã®ã¿ãƒ˜ãƒƒãƒ€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€2è¡Œç›®ã¯é€šå¸¸ã®æ‘˜è¦
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/02", "å€Ÿè²¸åŒºåˆ†": "å€Ÿæ–¹", "ç§‘ç›®å": "ç¾é‡‘", "é‡‘é¡": 5000, "æ‘˜è¦": "ã€æ›´æ–°ä¼ç¥¨ã€‘ å¥‘ç´„è€…: ç”°ä¸­å¤ªéƒ"},
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/02", "å€Ÿè²¸åŒºåˆ†": "è²¸æ–¹", "ç§‘ç›®å": "å£²ä¸Š", "é‡‘é¡": 5000, "æ‘˜è¦": "ç”°ä¸­å¤ªéƒ"},
    ]

    result = assign_voucher_numbers(entries, prefer_llm=False, width=4)

    # æ¤œè¨¼
    assert len(result) == 4, f"è¡Œæ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“: æœŸå¾…=4, å®Ÿéš›={len(result)}"
    assert result[0]["ä»•è¨³No"] == "0001", f"ä»•è¨³Noä¸ä¸€è‡´"
    assert result[1]["ä»•è¨³No"] == "0001", f"ä»•è¨³Noä¸ä¸€è‡´"
    assert result[2]["ä»•è¨³No"] == "0002", f"ãƒ˜ãƒƒãƒ€ã§åˆ†é›¢ã•ã‚Œã¦ã„ã¾ã›ã‚“: {result[2]['ä»•è¨³No']}"
    assert result[3]["ä»•è¨³No"] == "0002", f"ä»•è¨³Noä¸ä¸€è‡´"

    print("âœ… ãƒ†ã‚¹ãƒˆ3åˆæ ¼: ãƒ˜ãƒƒãƒ€èªå¥ã§å¼·åˆ¶åˆ†é›¢ã•ã‚Œã¾ã—ãŸ")
    return True


def test_complex_voucher():
    """å€Ÿæ–¹2è¡Œ+è²¸æ–¹1è¡Œã®è¤‡æ•°ãƒ¬ãƒƒã‚°å–å¼•"""
    print("\nğŸ§ª ãƒ†ã‚¹ãƒˆ4: è¤‡æ•°ãƒ¬ãƒƒã‚°å–å¼•ï¼ˆå€Ÿæ–¹2+è²¸æ–¹1ï¼‰")

    entries = [
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/01", "å€Ÿè²¸åŒºåˆ†": "å€Ÿæ–¹", "ç§‘ç›®å": "ç¾é‡‘", "é‡‘é¡": 40000, "æ‘˜è¦": "ä»•å…¥æ”¯æ‰•"},
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/01", "å€Ÿè²¸åŒºåˆ†": "å€Ÿæ–¹", "ç§‘ç›®å": "æ¶ˆè²»ç¨", "é‡‘é¡": 10000, "æ‘˜è¦": "ä»•å…¥æ”¯æ‰•"},
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/01", "å€Ÿè²¸åŒºåˆ†": "è²¸æ–¹", "ç§‘ç›®å": "è²·æ›é‡‘", "é‡‘é¡": 50000, "æ‘˜è¦": "ä»•å…¥æ”¯æ‰•"},
    ]

    result = assign_voucher_numbers(entries, prefer_llm=False, width=4)

    # æ¤œè¨¼
    assert len(result) == 3, f"è¡Œæ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“: æœŸå¾…=3, å®Ÿéš›={len(result)}"
    assert result[0]["ä»•è¨³No"] == "0001", f"ä»•è¨³Noä¸ä¸€è‡´"
    assert result[1]["ä»•è¨³No"] == "0001", f"ä»•è¨³Noä¸ä¸€è‡´"
    assert result[2]["ä»•è¨³No"] == "0001", f"ä»•è¨³Noä¸ä¸€è‡´"
    assert result[0]["å·®é¡"] == 0, f"è²¸å€Ÿä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“: å·®é¡={result[0]['å·®é¡']}"

    print("âœ… ãƒ†ã‚¹ãƒˆ4åˆæ ¼: è¤‡æ•°ãƒ¬ãƒƒã‚°ãŒ1ã¤ã®ä»•è¨³Noã«çµ±åˆã•ã‚Œã¾ã—ãŸ")
    return True


def test_tolerance():
    """èª¤å·®Â±1å††ã®è¨±å®¹"""
    print("\nğŸ§ª ãƒ†ã‚¹ãƒˆ5: èª¤å·®Â±1å††ã®è¨±å®¹")

    entries = [
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/01", "å€Ÿè²¸åŒºåˆ†": "å€Ÿæ–¹", "ç§‘ç›®å": "ç¾é‡‘", "é‡‘é¡": 10001, "æ‘˜è¦": "OCRèª¤èª­"},
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/01", "å€Ÿè²¸åŒºåˆ†": "è²¸æ–¹", "ç§‘ç›®å": "å£²ä¸Š", "é‡‘é¡": 10000, "æ‘˜è¦": "OCRèª¤èª­"},
    ]

    result = assign_voucher_numbers(entries, prefer_llm=False, width=4)

    # æ¤œè¨¼
    assert len(result) == 2, f"è¡Œæ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“"
    assert result[0]["ä»•è¨³No"] == "0001", f"ä»•è¨³Noä¸ä¸€è‡´"
    assert result[0]["warning"] == "", f"è­¦å‘ŠãŒå‡ºã‚‹ã¹ãã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆÂ±1å††è¨±å®¹ï¼‰"

    print("âœ… ãƒ†ã‚¹ãƒˆ5åˆæ ¼: èª¤å·®Â±1å††ãŒè¨±å®¹ã•ã‚Œã¾ã—ãŸ")
    return True


def test_sorting():
    """ä»•è¨³Noé †ã‚½ãƒ¼ãƒˆï¼ˆå€Ÿæ–¹â†’è²¸æ–¹ï¼‰"""
    print("\nğŸ§ª ãƒ†ã‚¹ãƒˆ6: ä»•è¨³Noé †ã‚½ãƒ¼ãƒˆ")

    entries = [
        {"ä»•è¨³No": "0002", "å€Ÿè²¸åŒºåˆ†": "è²¸æ–¹", "ç§‘ç›®å": "å£²ä¸Š", "é‡‘é¡": 20000},
        {"ä»•è¨³No": "0001", "å€Ÿè²¸åŒºåˆ†": "å€Ÿæ–¹", "ç§‘ç›®å": "ç¾é‡‘", "é‡‘é¡": 10000},
        {"ä»•è¨³No": "0001", "å€Ÿè²¸åŒºåˆ†": "è²¸æ–¹", "ç§‘ç›®å": "å£²ä¸Š", "é‡‘é¡": 10000},
        {"ä»•è¨³No": "0002", "å€Ÿè²¸åŒºåˆ†": "å€Ÿæ–¹", "ç§‘ç›®å": "ç¾é‡‘", "é‡‘é¡": 20000},
    ]

    result = sort_by_voucher_number(entries)

    # æ¤œè¨¼
    assert result[0]["ä»•è¨³No"] == "0001" and result[0]["å€Ÿè²¸åŒºåˆ†"] == "å€Ÿæ–¹"
    assert result[1]["ä»•è¨³No"] == "0001" and result[1]["å€Ÿè²¸åŒºåˆ†"] == "è²¸æ–¹"
    assert result[2]["ä»•è¨³No"] == "0002" and result[2]["å€Ÿè²¸åŒºåˆ†"] == "å€Ÿæ–¹"
    assert result[3]["ä»•è¨³No"] == "0002" and result[3]["å€Ÿè²¸åŒºåˆ†"] == "è²¸æ–¹"

    print("âœ… ãƒ†ã‚¹ãƒˆ6åˆæ ¼: ä»•è¨³Noé †ï¼‹å€Ÿæ–¹â†’è²¸æ–¹ã§ã‚½ãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸ")
    return True


def test_overall_balance():
    """å…¨ä½“ã®è²¸å€Ÿåˆè¨ˆæ¤œè¨¼"""
    print("\nğŸ§ª ãƒ†ã‚¹ãƒˆ7: å…¨ä½“ã®è²¸å€Ÿåˆè¨ˆæ¤œè¨¼")

    entries = [
        {"å€Ÿè²¸åŒºåˆ†": "å€Ÿæ–¹", "é‡‘é¡": 10000},
        {"å€Ÿè²¸åŒºåˆ†": "è²¸æ–¹", "é‡‘é¡": 10000},
        {"å€Ÿè²¸åŒºåˆ†": "å€Ÿæ–¹", "é‡‘é¡": 20000},
        {"å€Ÿè²¸åŒºåˆ†": "è²¸æ–¹", "é‡‘é¡": 20000},
    ]

    is_balanced, total_debit, total_credit = validate_overall_balance(entries)

    # æ¤œè¨¼
    assert is_balanced, f"è²¸å€ŸãŒä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“: å€Ÿæ–¹={total_debit}, è²¸æ–¹={total_credit}"
    assert total_debit == 30000, f"å€Ÿæ–¹åˆè¨ˆä¸ä¸€è‡´"
    assert total_credit == 30000, f"è²¸æ–¹åˆè¨ˆä¸ä¸€è‡´"

    print("âœ… ãƒ†ã‚¹ãƒˆ7åˆæ ¼: å…¨ä½“ã®è²¸å€ŸãŒä¸€è‡´ã—ã¦ã„ã¾ã™")
    return True


def test_same_date_different_amounts():
    """åŒæ—¥ãƒ»ç•°é‡‘é¡å–å¼•ãŒåˆ¥ä»•è¨³Noã«ãªã‚‹ãƒ†ã‚¹ãƒˆï¼ˆãƒ˜ãƒƒãƒ€èªå¥ã«ã‚ˆã‚‹åˆ†é›¢ï¼‰"""
    print("\nğŸ§ª ãƒ†ã‚¹ãƒˆ8: åŒæ—¥ãƒ»ç•°é‡‘é¡å–å¼•ã®åˆ†é›¢")

    entries = [
        # 1ä»¶ç›®ï¼ˆ10000å††ï¼‰- ãƒ˜ãƒƒãƒ€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãªã—
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/01", "å€Ÿè²¸åŒºåˆ†": "å€Ÿæ–¹", "ç§‘ç›®å": "ç¾é‡‘", "é‡‘é¡": 10000, "æ‘˜è¦": "å®¶è³ƒåå…¥ 2æœˆåˆ†"},
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/01", "å€Ÿè²¸åŒºåˆ†": "è²¸æ–¹", "ç§‘ç›®å": "å£²ä¸Š", "é‡‘é¡": 10000, "æ‘˜è¦": "å®¶è³ƒåå…¥ 2æœˆåˆ†"},
        # 2ä»¶ç›®ï¼ˆ20000å††ï¼‰- ãƒ˜ãƒƒãƒ€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œå¥‘ç´„è€…ã€ã‚’æœ€åˆã®è¡Œã®ã¿ã«å«ã‚€
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/01", "å€Ÿè²¸åŒºåˆ†": "å€Ÿæ–¹", "ç§‘ç›®å": "ç¾é‡‘", "é‡‘é¡": 20000, "æ‘˜è¦": "å®¶è³ƒåå…¥ å¥‘ç´„è€…: ç”°ä¸­å¤ªéƒ"},
        {"ä¼ç¥¨æ—¥ä»˜": "R07/02/01", "å€Ÿè²¸åŒºåˆ†": "è²¸æ–¹", "ç§‘ç›®å": "å£²ä¸Š", "é‡‘é¡": 20000, "æ‘˜è¦": "å®¶è³ƒåå…¥ ç”°ä¸­å¤ªéƒ"},
    ]

    result = assign_voucher_numbers(entries, prefer_llm=False, width=4)

    # æ¤œè¨¼
    assert len(result) == 4, f"è¡Œæ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“: æœŸå¾…=4, å®Ÿéš›={len(result)}"
    assert result[0]["ä»•è¨³No"] == "0001", f"ä»•è¨³Noä¸ä¸€è‡´"
    assert result[1]["ä»•è¨³No"] == "0001", f"ä»•è¨³Noä¸ä¸€è‡´"
    assert result[2]["ä»•è¨³No"] == "0002", f"åˆ¥ä»•è¨³Noã§åˆ†é›¢ã•ã‚Œã¦ã„ã¾ã›ã‚“: {result[2]['ä»•è¨³No']}"
    assert result[3]["ä»•è¨³No"] == "0002", f"ä»•è¨³Noä¸ä¸€è‡´"

    print("âœ… ãƒ†ã‚¹ãƒˆ8åˆæ ¼: åŒæ—¥ã§ã‚‚ç•°é‡‘é¡å–å¼•ãŒåˆ¥ä»•è¨³Noã§åˆ†é›¢ã•ã‚Œã¾ã—ãŸï¼ˆãƒ˜ãƒƒãƒ€èªå¥ã«ã‚ˆã‚‹ï¼‰")
    return True


def main():
    """å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"""
    print("=" * 70)
    print("ğŸ§ª ä»•è¨³Noä»˜ç•ªãƒ†ã‚¹ãƒˆ - è²¸å€Ÿä¸€è‡´ãƒ–ãƒ­ãƒƒã‚¯æ–¹å¼")
    print("=" * 70)

    tests = [
        test_basic_balance_close,
        test_multiple_vouchers,
        test_header_boundary,
        test_complex_voucher,
        test_tolerance,
        test_sorting,
        test_overall_balance,
        test_same_date_different_amounts,
    ]

    passed = 0
    failed = 0

    for test in tests:
        try:
            if test():
                passed += 1
        except AssertionError as e:
            print(f"âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: {e}")
            failed += 1
        except Exception as e:
            print(f"âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: {e}")
            import traceback
            traceback.print_exc()
            failed += 1

    print("\n" + "=" * 70)
    print(f"ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ: {passed}åˆæ ¼ / {failed}å¤±æ•— / {passed + failed}å®Ÿè¡Œ")

    if failed == 0:
        print("ğŸ‰ å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã«åˆæ ¼ã—ã¾ã—ãŸ!")
        return 0
    else:
        print("âŒ ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ")
        return 1


if __name__ == "__main__":
    exit_code = main()
    sys.exit(exit_code)
